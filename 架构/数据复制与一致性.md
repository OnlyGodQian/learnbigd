# 数据复制与一致性

### 原则一：CAP

##### 含义：

​	强一致性

​	可用性 : 读写操作都应该保证在限定延时内完成

​	分区容忍性：在存在网络分区的情况下，分区间的机器无法正常通信，系统应该能够在这种情况下仍能继续工作

##### 精髓

​	在一个系统中，这三个元素只能保证其中的两个，要么是CA，要么是AP，不存在CAP

##### CAP重装上阵

​	网络分区虽然会出现，但是并不是很频繁的出现，不能为了适应网络分区而在CA之间取舍，非C即A，而应该尝试满足CAP三个要素，在真的出现P的时候，再去解决P，并最终回到CAP状态

### 原则二：ACID（关系型数据库的原则）

* 原子性
* 一致性
* 事务独立：
  * 如果有多个事务同时执行，彼此之间不需要知道对方的存在，而且执行时互不影响，不允许出现两个事务交错、间隔执行部分任务的情形，也即事务之间需要序列化执行
* 持久性：
  * 事务的持久性是指事务运行成功后，对系统状态的更新是永久的，不会无缘无故回滚撤销

### 原则三：BASE

* 基本可用（Basically Available）

* 软状态或柔性状态（Soft State）：

  * 不要求在任意时刻都完全保持同步

* 最终一致性（Eventual Consistency）：

  * 要求在给定时间窗口内数据会达到一致状态

  现在的NoSQL系统与云存储系统的发展过程正在向逐步提供局部ACID特性发展，即从全局而言符合BASE原则，但是从局部支持ACID原则，这样可以吸收两者各自的好处，在两者之间建立平衡。

### 三个原则的关系

CAP的C是ACID中C所涵盖语义的子集，指的是数据的一致性，CAID的C指的是操作的一致性

### 幂等性

分布式系统中的幂等性指的是，反复执行同一操作与只正确执行一次操作效果相同，即对分布式系统内部状态来说，同一操作调用一次与反复调用多次其状态保持相同。

例如：Zookeeper与Raft

### 一致性模型分类

![](H:\git_project\learnbigd\resources\一致性模型.jpg)

* 强一致性
* 最终一致性
* 因果一致性
* “读你所写”一致性
* 会话一致性
* 单调读一致性
* 单调写一致性

### 副本更新策略

都要在低请求延时和数据一致性之间做出权衡和取舍

* 同时更新策略
* 主从式更新策略
  * 主副本通知从副本的方式：
    * 同步，等从副本也更新完成，主副本确认更新操作
    * 异步，不等从副本，主副本直接确定更新操作
    * 混合，等部分从副本更新完，主副本就确认更新操作，剩下的从副本就异步完成更新操作
* 任意节点更新策略
  * 不存在主副本，任意节点都可充当主副本，通知其他副本进行数据更新
    * 同步通知，跟主从式更新的同步方式类似
    * 异步通知，跟同时更新策略和主从式更新策略的异步方式类似

实际系统中，Dynamo、Cassandra、Riak同时采用了主从式更新策略中的混合方式，以及“任意节点更新”策略。