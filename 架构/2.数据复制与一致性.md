# 数据复制与一致性

### 原则一：CAP

##### 含义：

​	强一致性

​	可用性 : 读写操作都应该保证在限定延时内完成

​	分区容忍性：在存在网络分区的情况下，分区间的机器无法正常通信，系统应该能够在这种情况下仍能继续工作

##### 精髓

​	在一个系统中，这三个元素只能保证其中的两个，要么是CA，要么是AP，不存在CAP

##### CAP重装上阵

​	网络分区虽然会出现，但是并不是很频繁的出现，不能为了适应网络分区而在CA之间取舍，非C即A，而应该尝试满足CAP三个要素，在真的出现P的时候，再去解决P，并最终回到CAP状态

### 原则二：ACID（关系型数据库的原则）

* 原子性
* 一致性
* 事务独立：
  * 如果有多个事务同时执行，彼此之间不需要知道对方的存在，而且执行时互不影响，不允许出现两个事务交错、间隔执行部分任务的情形，也即事务之间需要序列化执行
* 持久性：
  * 事务的持久性是指事务运行成功后，对系统状态的更新是永久的，不会无缘无故回滚撤销

### 原则三：BASE

* 基本可用（Basically Available）

* 软状态或柔性状态（Soft State）：

  * 不要求在任意时刻都完全保持同步

* 最终一致性（Eventual Consistency）：

  * 要求在给定时间窗口内数据会达到一致状态

  现在的NoSQL系统与云存储系统的发展过程正在向逐步提供局部ACID特性发展，即从全局而言符合BASE原则，但是从局部支持ACID原则，这样可以吸收两者各自的好处，在两者之间建立平衡。

### 三个原则的关系

CAP的C是ACID中C所涵盖语义的子集，指的是数据的一致性，CAID的C指的是操作的一致性

### 幂等性

分布式系统中的幂等性指的是，反复执行同一操作与只正确执行一次操作效果相同，即对分布式系统内部状态来说，同一操作调用一次与反复调用多次其状态保持相同。

例如：Zookeeper与Raft

### 一致性模型分类

 <img src="..\resources\一致性模型.jpg" width="700"/> 



* 强一致性
* 最终一致性
* 因果一致性
* “读你所写”一致性
* 会话一致性
* 单调读一致性
* 单调写一致性

### 副本更新策略

都要在低请求延时和数据一致性之间做出权衡和取舍

* 同时更新策略
* 主从式更新策略
  * 主副本通知从副本的方式：
    * 同步，等从副本也更新完成，主副本确认更新操作
    * 异步，不等从副本，主副本直接确定更新操作
    * 混合，等部分从副本更新完，主副本就确认更新操作，剩下的从副本就异步完成更新操作
* 任意节点更新策略
  * 不存在主副本，任意节点都可充当主副本，通知其他副本进行数据更新
    * 同步通知，跟主从式更新的同步方式类似
    * 异步通知，跟同时更新策略和主从式更新策略的异步方式类似

实际系统中，Dynamo、Cassandra、Riak同时采用了主从式更新策略中的混合方式，以及“任意节点更新”策略。

### 一致性协议

- 两阶段提交协议（Two-Phrase-Commit）
  - 管理事务，协调者和参与者全部表决可以提交事务，则提交，否则，回滚
- 向量时钟（Vector Clock）
  - 分布式环境下生成事件之间偏序关系的算法，偏序关系代表事件发生先后顺序导致的事件因果依赖关系语义，通过将时间戳和事件绑定可以用来判断事件之间的因果相关性。
  - Dynamo系统使用向量时钟的协议维持数据的一致性
  - Riak是模仿Dynamo的开源键值NoSQL系统，也实现了类似的向量时钟机制进行版本控制与数据一致性维护
- RWN协议
  - N：在分布式存储系统中，有多少分备份数据
  - W：代表一次成功的写数据操作要求至少有W份数据写入成功
  - R：代表一次成功的读数据操作要求至少有R份数据成功读取
  - 如果满足下面的公式，则可称为满足“数据一致性协议”：
    - `W + R > N`
    - 如果满足公式，说明成功写入的备份集合和成功读取的备份集合一定存在交集，而这就可以保证数据的强一致性，即读取操作一定可以读到最新的数据版本。
    - 可以通过配置不同的W 和 R 来控制系统是读取快还是写入快
    - Dynamo系统，是通过RWN协议结合向量时钟来共同完成一致性保证的（因为要通过向量时钟来判断数据的新旧）
- Paxos协议
  - 倡议者
    - 首先发送prepare请求，附带倡议编号n---->接受者是否响应
    - 如果接受者响应了倡议者的请求，响应的内容中有此接受者以前接收过的accept请求的倡议值，倡议者收到接受者的响应后会继续发送accept请求，附带倡议编号n和值v，值v的选择从响应内容的倡议值中选取最大的，如果响应的内容没有倡议值，则随意选取。
  - 接受者
    - 首先接收到倡议者的prepare请求之后，如果这个prepare请求的倡议编号最大，则给倡议者发送响应
  - 学习者
    - 从接受者那里得到最终的倡议值
    - 可以选取一部分学习者为代表来从接受者那里获取最宠倡议值，效率较高。
  - Raft协议
    - 目的：
      - 可理解性（同等效果下选更容易理解的）
      - 实现实际系统的确定性
    - 手段：
      - 将整个一致性协议划分成明确且独立的3个子问题，即采取分解法，将其分为：
        - 领导者选举
          - 角色
            - Leader
            - Follower
            - Candidate
          - Term
            - Raft将整个系统执行时间划分为若干个不同时间间隔长度的时间片段构成的序列，每个时间片被称为一个Term
            - 在一个Term内最多有一个服务器会被选举称为新的领导者
        - log复制
          - 领导者接收到客户端的操作命令后，将其作为新项目追加到Log尾部，然后向集群内所有其他服务器发出AppendEntries RPC请求，这引发其他服务器复制新的操作命令。当其他服务器安全复制了新的操作命令后，领导者将这个操作命令应用到内部状态机，并将执行结果返回给客户端
        - 安全性
          - 增加了两个约束：
            - 其一，限制了哪些服务器可以被选举称为领导者，要求只有其Log包含了所有已经提交的操作命令的那些服务器才有权被选举为新的领导者
            - 其二，限制了哪些操作命令的提交可以被认为是真正的提交。对应新领导者来说，只有它自己已经提交过当前Term的操作命令才被认为是真正的提交。
      - 将Paxos的P2P模式改为 Master-Slave模式。
      - ...